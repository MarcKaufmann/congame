FROM ghcr.io/marckaufmann/racket:7.9-cs-full

RUN apt-get update \
  && apt-get install -y --no-install-recommends libgtk-3-0 libdbus-glib-1-2 xvfb

RUN curl -L 'https://download.mozilla.org/?product=firefox-latest-ssl&os=linux64&lang=en-US' > /tmp/firefox.tar \
    && (cd /tmp && tar -xvf firefox.tar) \
    && mv /tmp/firefox /opt/firefox \
    && ln -s /opt/firefox/firefox /usr/bin/firefox

WORKDIR /opt/congame
COPY .git /opt/congame/.git
COPY bin /opt/congame/bin
COPY ci /opt/congame/ci
COPY congame-core /opt/congame/congame-core
COPY congame-example-study /opt/congame/congame-example-study
COPY congame-pjb-studies/ /opt/congame/congame-pjb-studies
COPY congame-price-lists/ /opt/congame/congame-price-lists
COPY congame-tests /opt/congame/congame-tests
COPY congame-web /opt/congame/congame-web
COPY migrations /opt/congame/migrations
COPY resources /opt/congame/resources
COPY static /opt/congame/static

RUN ci/setup-catalogs.sh
RUN raco pkg install -D --auto --batch \
  congame-core/ \
  congame-example-study/ \
  congame-pjb-studies/ \
  congame-price-lists/ \
  congame-tests/ \
  congame-web/ \
CMD ["/opt/congame/bin/run-tests.sh"]
